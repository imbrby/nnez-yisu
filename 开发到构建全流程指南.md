# GitHub 云端构建 APK 全流程指南

本文档只说明一件事：如何使用 GitHub Actions 云端构建 APK。  
不包含任何本地构建步骤。

## 1. 项目目录结构（与云构建相关）

项目根目录：`D:\code\nnez-canteen-mobile`

```text
nnez-canteen-mobile/
├─ .github/
│  └─ workflows/
│     └─ android-apk.yml          # 云构建工作流（核心）
├─ android/
│  └─ app/
│     └─ build.gradle.kts         # Android 应用配置（包名、签名等）
├─ lib/                           # Flutter 业务代码
├─ test/                          # Flutter 测试（云端会执行）
├─ pubspec.yaml                   # 依赖与项目配置
├─ pubspec.lock                   # 依赖锁定
└─ README.md
```

## 2. 云构建工作流说明

工作流文件：`.github/workflows/android-apk.yml`

当前触发条件：

1. `push` 到 `main` 分支自动触发
2. `workflow_dispatch` 手动触发

云端执行步骤（GitHub Runner）：

1. Checkout 仓库代码
2. 安装 Java 17
3. 安装 Flutter stable
4. 执行 `flutter pub get`
5. 执行 `flutter analyze`
6. 执行 `flutter test`
7. 执行 `flutter build apk --release`
8. 上传构建产物 `app-release-apk`

云端产物实际来源路径：

`build/app/outputs/flutter-apk/app-release.apk`

## 3. 从改代码到触发云构建

只需要把代码推送到 `main`（或手动触发工作流）。

常用 Git 提交流程：

```powershell
cd D:\code\nnez-canteen-mobile
git add .
git commit -m "feat: 描述本次改动"
git push
```

推送到 `main` 后，GitHub 会自动启动 `Android APK` 工作流。

## 4. 手动触发云构建（不依赖 push）

适用于你想“重复构建同一份代码”时。

操作路径：

1. 打开仓库 GitHub 页面
2. 进入 `Actions`
3. 选择 `Android APK`
4. 点击 `Run workflow`
5. 选择分支（通常 `main`）
6. 点击确认运行

## 5. 查看构建进度与日志

进入某次 Actions Run 后，重点查看：

1. `Static analyze`
2. `Run tests`
3. `Build release APK`

判断规则：

1. 三个步骤都绿色通过，通常表示 APK 构建成功
2. 若失败，优先看失败步骤日志的最后 100 行
3. `analyze` 或 `test` 失败时，不会产生 APK 产物

## 6. 下载 APK（Artifacts）

构建成功后：

1. 打开该次 Run 详情页
2. 在页面底部 `Artifacts` 区域下载 `app-release-apk`
3. 解压 zip
4. 得到 `app-release.apk`

## 7. 常见问题定位（云构建场景）

1. `analyze` 失败  
现象：工作流在静态检查阶段中止。  
处理：修复对应文件告警/错误后重新 push 或手动重跑。

2. `test` 失败  
现象：测试步骤失败，后续不产出 APK。  
处理：修复失败测试，再触发工作流。

3. 构建成功但安装后行为异常  
处理：确认安装的是最新 Run 的 artifact；可比对该 Run 的提交 SHA。

4. 需要核对当前 APK 是否来自指定提交  
处理：打开该 Run 页面，检查 `head_sha` 与目标提交是否一致。

## 8. 当前签名状态（重要）

当前 `android/app/build.gradle.kts` 中，`release` 使用 debug 签名：

```kotlin
release {
    signingConfig = signingConfigs.getByName("debug")
}
```

含义：适合测试分发，不适合正式上架。  
如果后续要发布正式版本，需要改为正式 keystore 签名并通过 GitHub Secrets 注入密钥。
